From ed6b00aea08005945c9ae8a4a4503acc43f3a844 Mon Sep 17 00:00:00 2001
From: Samuel Thibault <samuel.thibault@labri.fr>
Date: Fri, 25 May 2018 10:25:33 +0200
Subject: [PATCH] Fix a buffer overflow in table parsing

Fixes #573

diff --git a/liblouis/pattern.c b/liblouis/pattern.c
index 2d1eeed4a..f31df5710 100644
--- a/liblouis/pattern.c
+++ b/liblouis/pattern.c
@@ -708,6 +708,8 @@ pattern_compile_expression(const widechar *input, const int input_max, int *inpu
 					expr_crs, loop_cnts))
 			return 0;
 
+		if (*expr_crs + 3 >= expr_max) return 0;
+
 		EXPR_NXT(expr_sub) = *expr_crs;
 
 		/* create end expression */
@@ -720,7 +722,7 @@ pattern_compile_expression(const widechar *input, const int input_max, int *inpu
 
 	case '+':
 
-		if (*expr_crs + 4 >= expr_max) return 0;
+		if (*expr_crs + 5 >= expr_max) return 0;
 		EXPR_TYPE(*expr_crs) = PTN_ONE_MORE;
 		EXPR_DATA_1(*expr_crs) = (*loop_cnts)++;
 		(*input_crs)++;
@@ -728,7 +730,7 @@ pattern_compile_expression(const widechar *input, const int input_max, int *inpu
 
 	case '*':
 
-		if (*expr_crs + 4 >= expr_max) return 0;
+		if (*expr_crs + 5 >= expr_max) return 0;
 		EXPR_TYPE(*expr_crs) = PTN_ZERO_MORE;
 		EXPR_DATA_1(*expr_crs) = (*loop_cnts)++;
 		(*input_crs)++;

